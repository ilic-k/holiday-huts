<div class="container mt-4">
  <h2>üë• Upravljanje Korisnicima</h2>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'all'" (click)="activeTab = 'all'" style="cursor: pointer;">
        Svi Korisnici ({{ users.length }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'pending'" (click)="activeTab = 'pending'" style="cursor: pointer;">
        ƒåekaju Odobrenje ({{ pendingUsers.length }})
      </a>
    </li>
  </ul>

  <!-- ALL USERS TAB -->
  @if (activeTab === 'all') {
    <div class="mb-3">
      <button class="btn btn-success" (click)="toggleCreateForm()">
        {{ showCreateForm ? 'Otka≈æi' : '+ Dodaj Novog Korisnika' }}
      </button>
    </div>

    <!-- CREATE FORM -->
    @if (showCreateForm) {
      <div class="card mb-4">
        <div class="card-body">
          <h5>Kreiranje Novog Korisnika</h5>
          <form (ngSubmit)="createUser()">
            <div class="row">
              <div class="col-md-6 mb-2">
                <label>Username *</label>
                <input type="text" class="form-control" [(ngModel)]="createForm.username" name="username" required>
              </div>
              <div class="col-md-6 mb-2">
                <label>Password *</label>
                <input type="password" class="form-control" [(ngModel)]="createForm.password" name="password" required>
              </div>
              <div class="col-md-6 mb-2">
                <label>Email *</label>
                <input type="email" class="form-control" [(ngModel)]="createForm.email" name="email" required>
              </div>
              <div class="col-md-6 mb-2">
                <label>Rola *</label>
                <select class="form-control" [(ngModel)]="createForm.role" name="role">
                  <option value="turista">Turista</option>
                  <option value="vlasnik">Vlasnik</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="col-md-6 mb-2">
                <label>Ime</label>
                <input type="text" class="form-control" [(ngModel)]="createForm.name" name="name">
              </div>
              <div class="col-md-6 mb-2">
                <label>Prezime</label>
                <input type="text" class="form-control" [(ngModel)]="createForm.lastname" name="lastname">
              </div>
              <div class="col-md-6 mb-2">
                <label>Pol</label>
                <select class="form-control" [(ngModel)]="createForm.gender" name="gender">
                  <option value="M">Mu≈°ki</option>
                  <option value="Z">≈Ωenski</option>
                </select>
              </div>
              <div class="col-md-6 mb-2">
                <label>Telefon</label>
                <input type="text" class="form-control" [(ngModel)]="createForm.phone" name="phone">
              </div>
              <div class="col-md-6 mb-2">
                <label>Adresa</label>
                <input type="text" class="form-control" [(ngModel)]="createForm.address" name="address">
              </div>
              <div class="col-md-6 mb-2">
                <label>Kreditna Kartica</label>
                <input type="text" class="form-control" [(ngModel)]="createForm.creditCard" name="creditCard">
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-2">Kreiraj</button>
            <button type="button" class="btn btn-secondary mt-2 ms-2" (click)="toggleCreateForm()">Otka≈æi</button>
          </form>
        </div>
      </div>
    }

    <!-- USERS TABLE -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Rola</th>
            <th>Ime</th>
            <th>Status</th>
            <th>Akcije</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user._id) {
            @if (editingUser?._id === user._id) {
              <!-- EDIT ROW -->
              <tr class="table-warning">
                <td>{{ user.username }}</td>
                <td><input type="email" class="form-control form-control-sm" [(ngModel)]="editForm.email"></td>
                <td>
                  <select class="form-control form-control-sm" [(ngModel)]="editForm.role">
                    <option value="turista">Turista</option>
                    <option value="vlasnik">Vlasnik</option>
                    <option value="admin">Admin</option>
                  </select>
                </td>
                <td><input type="text" class="form-control form-control-sm" [(ngModel)]="editForm.name"></td>
                <td>
                  <span class="badge" [class.bg-success]="user.approved && user.active" [class.bg-danger]="!user.active" [class.bg-warning]="!user.approved">
                    {{ user.approved ? (user.active ? 'Aktivan' : 'Deaktiviran') : 'Pending' }}
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-success me-1" (click)="saveEdit()">üíæ Saƒçuvaj</button>
                  <button class="btn btn-sm btn-secondary" (click)="cancelEdit()">‚úñ Otka≈æi</button>
                </td>
              </tr>
            } @else {
              <!-- NORMAL ROW -->
              <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <span class="badge" [class.bg-primary]="user.role === 'turista'" [class.bg-info]="user.role === 'vlasnik'" [class.bg-danger]="user.role === 'admin'">
                    {{ user.role }}
                  </span>
                </td>
                <td>{{ user.name }} {{ user.lastname }}</td>
                <td>
                  <span class="badge" [class.bg-success]="user.approved && user.active" [class.bg-danger]="!user.active" [class.bg-warning]="!user.approved">
                    {{ user.approved ? (user.active ? 'Aktivan' : 'Deaktiviran') : 'Pending' }}
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-primary me-1" (click)="startEdit(user)">‚úèÔ∏è Izmeni</button>
                  @if (user.active) {
                    <button class="btn btn-sm btn-warning me-1" (click)="deactivateUser(user._id)">üö´ Deaktiviraj</button>
                  } @else {
                    <button class="btn btn-sm btn-success me-1" (click)="activateUser(user._id)">‚úÖ Aktiviraj</button>
                  }
                  <button class="btn btn-sm btn-danger" (click)="deleteUser(user._id)">üóëÔ∏è Obri≈°i</button>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  }

  <!-- PENDING USERS TAB -->
  @if (activeTab === 'pending') {
    @if (pendingUsers.length === 0) {
      <div class="alert alert-info">
        Nema korisnika koji ƒçekaju odobrenje.
      </div>
    } @else {
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Rola</th>
              <th>Datum Registracije</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody>
            @for (user of pendingUsers; track user._id) {
              <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <span class="badge" [class.bg-primary]="user.role === 'turista'" [class.bg-info]="user.role === 'vlasnik'">
                    {{ user.role }}
                  </span>
                </td>
                <td>{{ user.createdAt | date:'dd.MM.yyyy HH:mm' }}</td>
                <td>
                  <button class="btn btn-sm btn-success me-2" (click)="approveUser(user._id)">‚úÖ Odobri</button>
                  <button class="btn btn-sm btn-danger" (click)="rejectUser(user._id)">‚ùå Odbij</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  }
</div>

